# Inflation Handling in the FIRE Simulation

## Overview

Inflation is a critical component of the FIRE (Financial Independence, Retire Early) simulation, as
it affects the real value of all cash flows, asset values, expenses, and planned events over time.
The simulation models inflation stochastically, applies it to all relevant flows, and provides tools
for converting between nominal (future) and real (today's) values.

---

## Key Concepts and Sequences

The simulation manages inflation using two primary sequences derived from monthly data:

### 1. **Monthly Inflation Rate Sequence**

- **Variable (in simulation state):** `monthly_inflations_sequence`
- **Type:** `list[float]` (length = number of months)
- **Description:** For each simulation run, a random inflation rate is drawn **for each month**.
  These rates are sampled from a monthly lognormal distribution. The parameters for this monthly
  distribution (`mu_log_monthly_inf`, `sigma_log_monthly_inf`) are derived from the annual
  **arithmetic** mean and standard deviation for inflation provided in the configuration, via an
  intermediate conversion to annual **lognormal** parameters. This sequence is the fundamental
  source of inflation randomness in the simulation.

### 2. **Monthly Cumulative Inflation Factors**

- **Variable (in simulation state):** `monthly_cumulative_inflation_factors`
- **Type:** `list[float]` (length = number of months + 1)
- **Description:** This list holds the compounded effect of inflation up to each month, using the
  directly sampled `monthly_inflations_sequence`.
  - `monthly_cumulative_inflation_factors[0]` is always 1.0 (start of simulation).
  - For month `m`, it is the product of `(1 + monthly_rate)` for all months up to `m` from the
    `monthly_inflations_sequence`.
- **Usage:** This is the **primary tool** for converting any real (today's money) value to its
  nominal (future money) equivalent at any specific month. It is used for:
  - Adjusting planned contributions, extra expenses, salary, pension, and house purchase costs
    (which are specified in real terms by year) to their nominal values at the start of the
    relevant year (i.e., indexed at `year_idx * 12`).
  - Converting nominal asset values and balances to real terms for reporting and plotting.
  - Adjusting bank account bounds (specified in real terms) to nominal values for each month.

---

## How Inflation Is Applied

### 1. **Derivation of Monthly Inflation Parameters and Monthly Draws**

- At the start of each simulation:
  - Annual **arithmetic** mean (`pi_mu`) and standard deviation (`pi_sigma`) for the inflation rate
    are taken from the configuration's `[market_assumptions]`.
  - These annual arithmetic parameters are converted to annual **lognormal** parameters
    (`mu_log_annual_inf`, `sigma_log_annual_inf`).
  - These annual lognormal parameters are then converted to their corresponding monthly
    **lognormal** parameters (`mu_log_monthly_inf`, `sigma_log_monthly_inf`).
  - The `monthly_inflations_sequence` (a list of floats) is generated by drawing a random value for
    **each month** of the simulation from this derived monthly lognormal distribution. Each draw
    represents the inflation rate for that specific month (e.g., `rate = draw - 1.0` if draws are
    `1+rate`). This sequence is stored in the simulation state.

### 2. **Reconstruction of Annual Inflation Data (for reporting/reference)**

- Although not stored as primary state variables for simulation logic, an
  `annual_inflations_sequence` can be reconstructed for reporting or analysis. For each year, the 12
  corresponding monthly inflation rates from `monthly_inflations_sequence` are compounded to
  determine the effective annual inflation rate for that year.
- Similarly, `annual_cumulative_inflation_factors` can be derived by cumulatively multiplying
  `(1 + reconstructed_annual_rate)` from such a reconstructed annual sequence. These are also
  primarily for reporting purposes.

### 3. **Cumulative Factors Calculation (Monthly)**

- **Monthly cumulative factors** (`monthly_cumulative_inflation_factors`) are computed by
  cumulatively multiplying `(1 + monthly_rate)` from the `monthly_inflations_sequence`. This is the
  primary list used for all inflation adjustments within the simulation and is stored in the
  simulation state.

### 4. **Application in Simulation Logic**

- All flows (contributions, expenses, salary, pension, house purchase) and bank account bounds,
  which are typically defined in real terms in the configuration, are converted to **nominal terms**
  using the `monthly_cumulative_inflation_factors` stored in the state.
  - For items specified by year (e.g., a planned contribution in year `N`), the
    `monthly_cumulative_inflation_factors[N * 12]` is used to get the cumulative inflation up to the
    start of that year.
- All asset balances are managed in nominal terms during the simulation.
- When reporting or plotting, nominal values are converted back to real terms using the
  `monthly_cumulative_inflation_factors` indexed to the appropriate month.

---

## Why This Approach?

- **Efficiency & Granularity:** Precomputing `monthly_cumulative_inflation_factors` allows for
  instant conversion between real and nominal values at any month. Using monthly draws allows for
  finer-grained stochasticity.
- **Transparency:** Storing the `monthly_inflations_sequence` allows for reproducibility and
  detailed analysis. Annual figures can be reconstructed if needed.
- **Flexibility:** The approach supports both annual and monthly logic for adjustments and can
  easily accommodate planned events at any time step using the monthly factors.

---

## Summary Table of Stored Inflation Sequences

| Sequence Name                        | Variable Name                          | Type          | Purpose                                                         |
| ------------------------------------ | -------------------------------------- | ------------- | --------------------------------------------------------------- |
| Monthly inflation rates              | `monthly_inflations_sequence`          | `list[float]` | Stochastic monthly inflation path; primary source of randomness |
| Monthly cumulative inflation factors | `monthly_cumulative_inflation_factors` | `list[float]` | Convert real to nominal for any month; used for all adjustments |

---

## Notes

- The simulation **does** store the `monthly_inflations_sequence` as it's the basis for all
  inflation calculations.
- An `annual_inflations_sequence` can be reconstructed from the monthly sequence for analysis, but
  it is not a primary state variable used in the simulation's core adjustment logic.
- All inflation logic is centralized in the `_precompute_sequences` method of the `Simulation`
  class.
- This design ensures both accuracy and performance for large-scale Monte Carlo simulations.
